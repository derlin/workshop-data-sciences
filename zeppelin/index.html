
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
        <meta name="author" content="Lucy Linder (DAPLAB)">
      
      
        <link rel="shortcut icon" href="../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.10.1">
    
    
      
        <title>Hello Zeppelin - Workshop data sciences</title>
      
    
    
      <script src="../assets/javascripts/modernizr-e826f8942a.js"></script>
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-a20f419c8e.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-23f75ab9c7.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../style.css">
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="blue" data-md-color-accent="orange">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Workshop data sciences" class="md-header-nav__button md-logo">
          
            <i class="md-icon md-icon--home"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
            
            Hello Zeppelin
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="" data-md-lang-tokenizer="[\s\-]+">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <div class="md-nav__button md-logo">
      
        <i class="md-icon md-icon--home"></i>
      
    </div>
    Workshop data sciences
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../hdfs/" title="HDFS" class="md-nav__link">
      HDFS
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../mapreduce/" title="MapReduce" class="md-nav__link">
      MapReduce
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../hive/" title="Hive" class="md-nav__link">
      Hive
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Hello Zeppelin
      </label>
    
    <a href="./" title="Hello Zeppelin" class="md-nav__link md-nav__link--active">
      Hello Zeppelin
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#environment-setup" title="Environment setup" class="md-nav__link">
    Environment setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" title="Getting Started" class="md-nav__link">
    Getting Started
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-a-new-notebook" title="Creating a new notebook" class="md-nav__link">
    Creating a new notebook
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#basic-concepts" title="Basic concepts" class="md-nav__link">
    Basic concepts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#list-of-interpreter-prefixes" title="List of interpreter prefixes" class="md-nav__link">
    List of interpreter prefixes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-first-example" title="A first example" class="md-nav__link">
    A first example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#battling-with-pyspark" title="Battling with pyspark" class="md-nav__link">
    Battling with pyspark
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spark-context" title="Spark Context" class="md-nav__link">
    Spark Context
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loading-the-data" title="Loading the data" class="md-nav__link">
    Loading the data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visualising-the-data" title="Visualising the data" class="md-nav__link">
    Visualising the data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simple-aggregation" title="Simple aggregation" class="md-nav__link">
    Simple aggregation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interactive-queries" title="Interactive queries" class="md-nav__link">
    Interactive queries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#battling-with-spark-sql" title="Battling with Spark SQL" class="md-nav__link">
    Battling with Spark SQL
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#registering-a-table" title="Registering a table" class="md-nav__link">
    Registering a table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simple-aggregation_1" title="Simple aggregation" class="md-nav__link">
    Simple aggregation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interactive-queries_1" title="Interactive queries" class="md-nav__link">
    Interactive queries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../spark/" title="Spark" class="md-nav__link">
      Spark
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../lsa/" title="LSA" class="md-nav__link">
      LSA
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#environment-setup" title="Environment setup" class="md-nav__link">
    Environment setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" title="Getting Started" class="md-nav__link">
    Getting Started
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-a-new-notebook" title="Creating a new notebook" class="md-nav__link">
    Creating a new notebook
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#basic-concepts" title="Basic concepts" class="md-nav__link">
    Basic concepts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#list-of-interpreter-prefixes" title="List of interpreter prefixes" class="md-nav__link">
    List of interpreter prefixes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-first-example" title="A first example" class="md-nav__link">
    A first example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#battling-with-pyspark" title="Battling with pyspark" class="md-nav__link">
    Battling with pyspark
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spark-context" title="Spark Context" class="md-nav__link">
    Spark Context
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loading-the-data" title="Loading the data" class="md-nav__link">
    Loading the data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visualising-the-data" title="Visualising the data" class="md-nav__link">
    Visualising the data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simple-aggregation" title="Simple aggregation" class="md-nav__link">
    Simple aggregation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interactive-queries" title="Interactive queries" class="md-nav__link">
    Interactive queries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#battling-with-spark-sql" title="Battling with Spark SQL" class="md-nav__link">
    Battling with Spark SQL
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#registering-a-table" title="Registering a table" class="md-nav__link">
    Registering a table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simple-aggregation_1" title="Simple aggregation" class="md-nav__link">
    Simple aggregation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interactive-queries_1" title="Interactive queries" class="md-nav__link">
    Interactive queries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Hello Zeppelin</h1>
                
                <p>Apache Zeppelin is an online notebook that lets you interact with a HADOOP cluster (or any other hadoop/spark installation) through many languages and technology backends. </p>
<p>In this workshop, we will use Zeppelin to explore data with Spark. </p>
<h2 id="environment-setup">Environment setup</h2>
<p>To simplify, we will use a local Zeppelin running on a Docker container on your local machine. </p>
<details class="info"><summary>What is Docker?</summary><p>Docker is a tool designed to make it easier to create, deploy, and run applications by using <em>containers</em>.</p><p>Containers are a way to package software in a format that can run isolated on a shared operating system. Unlike VMs, containers do not bundle a full operating system - only libraries and settings required to make the software work are needed. This makes for efficient, lightweight, self-contained systems and guarantees that software will always run the same, regardless of where it’s deployed.</p></details><p>By now, you should have Docker running on your machine as well as snorkel set up. Simply start zeppelin (see <a href="..#setting-up-snorkel">how to setup Snorkel ?</a>) and navigate to <a href="http://localhost:8080/" target="_blank">http://localhost:8080/</a>.</p>
<h2 id="getting-started">Getting Started</h2>
<h3 id="creating-a-new-notebook">Creating a new notebook</h3>
<p>On the home page or on the notebook menu, select "<em>create new...</em>". Once the notebook is opened, give it a new name.</p>
<div class="admonition tip">
<p class="admonition-title">Creating folders</p>
<p>Using slashes (<code class="codehilite">/</code>) in the notebook name will automatically create and/or move the notebook into folders.</p>
</div>
<h3 id="basic-concepts">Basic concepts</h3>
<p>A notebook is made of <em>cells</em>, also called <em>paragraphs</em>. A cell has an <em>interpreter</em> that tells Zeppelin which langage/backend to use to run the cell.</p>
<p>The interpreter is configured by writing <code class="codehilite"><span class="c">%&lt;interpreter name&gt;</span></code> at the top of the cell. Without it, Zeppelin will use the default interpreter, which you can configure by clicking on <i class="fa fa-cog" aria-hidden="true"></i> <em>&gt; interpreters</em> at the top right of the notebook (drag-drop to re-order them, the first one being the default).</p>
<p>You can run cells by clicking on the <i class="fa fa-play" aria-hidden="true"></i> icon on the right or using the shortcut <code class="codehilite">shift+enter</code>. </p>
<div class="admonition tip">
<p class="admonition-title">shortcuts</p>
<p>Many useful shortcuts exist in edit mode. Click on <i class="fa fa-keyboard-o" aria-hidden="true"></i> the at the top right of a notebook to display them.</p>
</div>
<p>The first time you run a cell of a given type, an new <em>instance</em> of the interpreter is started (it might take a moment). This instance will then be used for all subsequent run of any cell configured with the same language. This is nice, because it means you can share variables and code between cells. </p>
<div class="admonition tip">
<p class="admonition-title">In case of trouble</p>
<p>If something goes wrong, you can restart an interpreter any time using the <i class="fa fa-cog" aria-hidden="true"></i> <em>&gt; interpreters</em> and then clicking on the <i class="fa fa-refresh"></i> icon alongside the interpreter name.</p>
</div>
<h3 id="list-of-interpreter-prefixes">List of interpreter prefixes</h3>
<p>Interpreters and prefixes may vary between the installations. On your local Zeppelin, the following interpreters are available: </p>
<table>
<thead>
<tr>
<th align="left">Prefix</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code class="codehilite"><span class="nf">%spark</span></code></td>
<td align="left">Spark (scala)</td>
</tr>
<tr>
<td align="left"><code class="codehilite"><span class="nf">%pyspark</span></code></td>
<td align="left">Spark (python)</td>
</tr>
<tr>
<td align="left"><code class="codehilite"><span class="nf">%sql</span></code></td>
<td align="left">Spark SQL</td>
</tr>
<tr>
<td align="left"><code class="codehilite"><span class="nf">%dep</span></code></td>
<td align="left">special syntax to load external dependencies</td>
</tr>
<tr>
<td align="left"><code class="codehilite"><span class="nf">%md</span></code></td>
<td align="left">MarkDown cell</td>
</tr>
<tr>
<td align="left"><code class="codehilite"><span class="nf">%sh</span></code></td>
<td align="left">shell script (bash)</td>
</tr>
<tr>
<td align="left"><code class="codehilite"><span class="nf">%python</span></code></td>
<td align="left">"regular" python</td>
</tr>
</tbody>
</table>
<p><em>Note</em>: <code class="codehilite">spark</code> is Spark 1.6, <code class="codehilite">spark2</code> is Spark 2.1.0.</p>
<h3 id="a-first-example">A first example</h3>
<p>To test Zeppelin, create a new notebook. </p>
<p><strong>Shell cell</strong>: </p>
<p>On the first cell, enter the snippet below:</p>
<div class="codehilite"><pre><span></span>%sh
<span class="nb">echo</span> <span class="s2">&quot;The working directory is </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">, it contains:&quot;</span>
ls
</pre></div>

<p>As you can see, this is a regular shell script that will run inside the docker container. The working directory is <code class="codehilite">/zeppelin</code>, which contains some folders that are also available from your filesystem:</p>
<table>
<thead>
<tr>
<th align="left">Zeppelin path</th>
<th align="left">Local path</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code class="codehilite">/zeppelin/data</code></td>
<td align="left"><code class="codehilite">snorkel/zeppelin/data</code></td>
<td align="left">Empty directory you can use to store input and output data</td>
</tr>
<tr>
<td align="left"><code class="codehilite">/zeppelin/logs</code></td>
<td align="left"><code class="codehilite">snorkel/zeppelin/logs</code></td>
<td align="left">Zeppelin logs</td>
</tr>
<tr>
<td align="left"><code class="codehilite">/zeppelin/notebooks</code></td>
<td align="left"><code class="codehilite">snorkel/zeppelin/notebooks</code></td>
<td align="left">Where Zeppelin stores the notebooks (in a special <code class="codehilite"><span class="na">.json</span></code> format)... Don't erase it !</td>
</tr>
<tr>
<td align="left"><code class="codehilite">/zeppelin/spark-warehouse</code></td>
<td align="left"><code class="codehilite">snorkel/zeppelin/spark-warehouse</code></td>
<td align="left">A special directory used by Spark for storing temp tables and such</td>
</tr>
</tbody>
</table>
<p><strong>Markdown cell</strong>:</p>
<p>On a new cell, type some markdown and press <code class="codehilite">shift+enter</code>:</p>
<div class="codehilite"><pre><span></span>%md
<span class="gh">#</span> Title
<span class="gu">##</span> Subtitle
I am testing the <span class="ge">_Zeppelin_</span> functionalities, specifically the <span class="sb">`%markdown`</span> 
interpreter. I can even do some nice <span class="gs">__latex math__</span> using the \$\$ delimiters!
Example:

$$ \frac{N}{4} * log(t) $$
</pre></div>

<p><strong>Let's do some python:</strong></p>
<p>On a new cell, type the following:</p>
<div class="codehilite"><pre><span></span><span class="o">%</span><span class="n">python</span>
<span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

<p>You should have the result <code class="codehilite">[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</code> displayed. Now, store the result into a variable:</p>
<div class="codehilite"><pre><span></span><span class="o">%</span><span class="n">python</span>
<span class="n">lst</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

<p>As you can see, no output is shown. This is because the last statement, here an assignment, does not return anything. To still view the result, add <code class="codehilite">print(lst)</code> at the end of the cell.</p>
<p>Inside a new cell, let's define a function:</p>
<div class="codehilite"><pre><span></span><span class="o">%</span><span class="n">python</span>
<span class="k">def</span> <span class="nf">add_lists</span><span class="p">(</span><span class="n">lst_a</span><span class="p">,</span> <span class="n">lst_b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; do an addition term by term between two lists &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lst_a</span><span class="p">,</span> <span class="n">lst_b</span><span class="p">)</span> <span class="p">]</span>
</pre></div>

<p>Once you ran the cell, the function exists in the current context, so you can use it anywhere in your notebook. In case you need to make a change to the function, simply rerun the cell with the updated code.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When you stop the docker container or reload an interpreter, the current context is lost and you need to rerun the cells.</p>
</div>
<hr />
<h2 id="battling-with-pyspark">Battling with pyspark</h2>
<p>Let's explore the <a href="https://raw.githubusercontent.com/maxtoki/baseball_R/master/data/Batting.csv" target="_blank">battling.csv</a>. It is a csv file containing information on baseball games. The columns are:</p>
<table>
<thead>
<tr>
<th align="left">Column name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code class="codehilite">playerID</code></td>
<td align="left">Player ID code</td>
</tr>
<tr>
<td align="left"><code class="codehilite">yearID</code></td>
<td align="left">Year</td>
</tr>
<tr>
<td align="left"><code class="codehilite">stint</code></td>
<td align="left">player's stint (order of appearances within a season)</td>
</tr>
<tr>
<td align="left"><code class="codehilite">teamID</code></td>
<td align="left">Team</td>
</tr>
<tr>
<td align="left"><code class="codehilite">lgID</code></td>
<td align="left">League</td>
</tr>
<tr>
<td align="left"><code class="codehilite">G</code></td>
<td align="left">Games</td>
</tr>
<tr>
<td align="left"><code class="codehilite">G_batting</code></td>
<td align="left">Game as batter</td>
</tr>
<tr>
<td align="left"><code class="codehilite">AB</code></td>
<td align="left">At Bats</td>
</tr>
<tr>
<td align="left"><code class="codehilite">R</code></td>
<td align="left">Runs</td>
</tr>
<tr>
<td align="left"><code class="codehilite">H</code></td>
<td align="left">Hits</td>
</tr>
<tr>
<td align="left"><code class="codehilite">2B</code></td>
<td align="left">Doubles</td>
</tr>
<tr>
<td align="left"><code class="codehilite">3B</code></td>
<td align="left">Triples</td>
</tr>
<tr>
<td align="left"><code class="codehilite">HR</code></td>
<td align="left">Homeruns</td>
</tr>
<tr>
<td align="left"><code class="codehilite">RBI</code></td>
<td align="left">Runs Batted In</td>
</tr>
<tr>
<td align="left"><code class="codehilite">SB</code></td>
<td align="left">Stolen Bases</td>
</tr>
<tr>
<td align="left"><code class="codehilite">CS</code></td>
<td align="left">Caught Stealing</td>
</tr>
<tr>
<td align="left"><code class="codehilite">BB</code></td>
<td align="left">Base on Balls</td>
</tr>
<tr>
<td align="left"><code class="codehilite">SO</code></td>
<td align="left">Strikeouts</td>
</tr>
<tr>
<td align="left"><code class="codehilite">IBB</code></td>
<td align="left">Intentional walks</td>
</tr>
<tr>
<td align="left"><code class="codehilite">HBP</code></td>
<td align="left">Hit by pitch</td>
</tr>
<tr>
<td align="left"><code class="codehilite">SH</code></td>
<td align="left">Sacrifice hits</td>
</tr>
<tr>
<td align="left"><code class="codehilite">SF</code></td>
<td align="left">Sacrifice flies</td>
</tr>
<tr>
<td align="left"><code class="codehilite">GIDP</code></td>
<td align="left">Grounded into double plays</td>
</tr>
</tbody>
</table>
<h3 id="spark-context">Spark Context</h3>
<p>To interact with Spark, we need a <em>Spark Context</em>. </p>
<p>In Zeppelin, the context is created for us and available through the <code class="codehilite">spark</code> variable. Likewise, the <em>Spark SQL Context</em> is stored in the <code class="codehilite">sqlContext</code> variable.</p>
<div class="codehilite"><pre><span></span><span class="o">%</span><span class="n">pyspark</span>
<span class="k">print</span><span class="p">(</span><span class="n">spark</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">sqlContext</span><span class="p">)</span>
</pre></div>

<h3 id="loading-the-data">Loading the data</h3>
<p>Download the <a href="https://raw.githubusercontent.com/maxtoki/baseball_R/master/data/Batting.csv" target="_blank">battling.csv</a> file and save it in <code class="codehilite">snorkel/zeppelin/data</code>. </p>
<p>To read CSV data into a <em>Spark Dataframe</em>, nothing is more easy:</p>
<div class="codehilite"><pre><span></span><span class="o">%</span><span class="n">pysark</span>
<span class="n">battingFile</span> <span class="o">=</span> <span class="s2">&quot;data/Batting.csv&quot;</span>
<span class="n">batting</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">battingFile</span><span class="p">,</span> 
    <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;DROPMALFORMED&quot;</span><span class="p">,</span> <span class="n">inferSchema</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>

<h3 id="visualising-the-data">Visualising the data</h3>
<p>A <em>SparkDataframe</em> has two interesting methods to visualize the content:</p>
<ul>
<li><code class="codehilite">describe()</code>: prints the dataframe <em>schema</em>, i.e. the columns and their types</li>
<li><code class="codehilite">show()</code> or <code class="codehilite">show(numRows, truncate=truncate)</code>: prints the content of dataframe as a table. By default, only the first 20 rows are shown and the content of the cells might be truncated from better readability;</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nf">%pyspark</span>
<span class="n">batting</span><span class="p">.</span><span class="n">describe</span><span class="p">()</span>
<span class="n">batting</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

<p>To have an even better view, we can use the Zeppelin method <code class="codehilite">z.show()</code> (<code class="codehilite">z</code> is a global variable used to interact with Zeppelin):
<div class="codehilite"><pre><span></span><span class="nf">%pyspark</span>
<span class="n">z</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="n">batting</span><span class="p">)</span>
</pre></div></p>
<h3 id="simple-aggregation">Simple aggregation</h3>
<p>A <em>Spark Dataframe</em> is like a table, with rows and columns. It is possible to do most of the operations you would do on an SQL table.</p>
<p>First, let's compute some statistics per year:</p>
<div class="codehilite"><pre><span></span><span class="o">%</span><span class="n">pyspark</span>

<span class="c1"># import the sum function </span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="nb">sum</span> 

<span class="c1"># compute aggregations. In SQL, this would be written:</span>
<span class="n">statsPerYear</span> <span class="o">=</span> <span class="n">batting</span>\
    <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;yearID&quot;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;total runs&quot;</span><span class="p">),</span> 
        <span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;total hits&quot;</span><span class="p">),</span> 
        <span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;G&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;total games&quot;</span><span class="p">))</span>\
    <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;yearID&quot;</span><span class="p">)</span>

<span class="n">z</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">statsPerYear</span><span class="p">)</span>
</pre></div>

<details class="info"><summary>SQL equivalent</summary><p>In SQL syntax, this query would look like:</p><div class="codehilite"><pre><span></span><span class="n">ELECT</span> <span class="n">R</span> <span class="k">as</span> <span class="ss">&quot;total runs&quot;</span><span class="p">,</span> <span class="n">H</span> <span class="k">as</span> <span class="ss">&quot;total hits&quot;</span><span class="p">,</span> <span class="k">G</span> <span class="k">as</span> <span class="ss">&quot;total games&quot;</span>
<span class="k">FROM</span> <span class="n">batting</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">yearID</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">yearID</span>
</pre></div>
</details><p>On the interface, select the line chart <i class="fa fa-line-chart" aria-hidden="true"></i> or area chart <i class="fa fa-area-chart" aria-hidden="true"></i> and then click on <em>settings</em>. Drag-and-drop the statistics into the <em>Values</em> area:</p>
<p><img alt="Batting with Zeppelin - statistics per year" src="../resources/zeppelin-batting-graph.png" /></p>
<h3 id="interactive-queries">Interactive queries</h3>
<p>Zeppelin offers methods to create simple forms. The basic syntax is:</p>
<div class="codehilite"><pre><span></span><span class="n">z</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;&lt;input name&gt;&quot;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">default</span> <span class="n">value</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>

<p>Let's use an input form to display the hit by pitch per team for a given year:</p>
<div class="codehilite"><pre><span></span><span class="o">%</span><span class="n">pyspark</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">avg</span>

<span class="c1"># get user input</span>
<span class="n">year</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="mi">1894</span><span class="p">)</span>

<span class="c1"># do the query</span>
<span class="n">hbp_results</span> <span class="o">=</span> <span class="n">batting</span>\
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">batting</span><span class="o">.</span><span class="n">yearID</span> <span class="o">==</span> <span class="n">year</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;teamID&quot;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="s2">&quot;HBP&quot;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;average hit by pitch&quot;</span><span class="p">))</span>

<span class="c1"># display the results</span>
<span class="n">z</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">hbp_results</span><span class="p">)</span>
</pre></div>

<p>As you can see, the query is rerun everytime the input changes.</p>
<p><code class="codehilite">z.input</code> creates a simple input text, but you can also use <code class="codehilite">z.select(&quot;input title&quot;, labels, values)</code> for a dropdown and <code class="codehilite">z.checkbox(&quot;input title&quot;, default_value)</code> for multiple choices. </p>
<p>For example, we could create a dropdown for all teams like this:</p>
<div class="codehilite"><pre><span></span><span class="o">%</span><span class="n">pyspark</span>
<span class="c1"># get all team names</span>
<span class="n">all_teams</span> <span class="o">=</span> <span class="n">batting</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;teamID&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="c1"># we get a list of Row(teamsId). Get rid of the Row wrapper!</span>
<span class="n">all_teams</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">all_teams</span><span class="p">]</span>

<span class="c1"># create and show a dropdown form</span>
<span class="n">team</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;selected team&quot;</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">all_teams</span><span class="p">,</span> <span class="n">all_teams</span><span class="p">)))</span>

<span class="c1"># go something with the results, for example listing the years when the team played</span>
<span class="n">years_played</span> <span class="o">=</span> <span class="n">batting</span>\
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">batting</span><span class="o">.</span><span class="n">yearID</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;years played&#39;</span><span class="p">))</span>\
    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">batting</span><span class="o">.</span><span class="n">teamID</span> <span class="o">==</span> <span class="n">team</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">distinct</span><span class="p">()</span>\
    <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;years played&quot;</span><span class="p">)</span>

<span class="n">z</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">years_played</span><span class="p">)</span>
</pre></div>

<p>Have a look at the <a href="https://zeppelin.apache.org/docs/latest/manual/dynamicform.html" target="_blank">Zeppelin documentation</a> for more information and examples.</p>
<hr />
<h2 id="battling-with-spark-sql">Battling with Spark SQL</h2>
<p>From the code so far, you might have noticed how similar to SQL queries our code were. What if we could get rid of the difficult python syntax and use a declarative language instead ? Well, we can. </p>
<h3 id="registering-a-table">Registering a table</h3>
<p>To use the SQL syntax directly, we first need to register our dataframe as a table and give it name:</p>
<div class="codehilite"><pre><span></span><span class="o">%</span><span class="n">pyspark</span>
<span class="n">batting</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;batting&quot;</span><span class="p">)</span> 
<span class="c1"># or registerTempTable(&quot;batting&quot;) for older spark versions</span>
</pre></div>

<p>The name can be anything; we will be used in SQL queries, for example in a <code class="codehilite">FROM</code> clause, to refer to the <code class="codehilite">batting</code> dataframe.</p>
<h3 id="simple-aggregation_1">Simple aggregation</h3>
<p>From now on, we can run SQL-like queries using the <code class="codehilite">sqlContext</code>. For example (the triple quotes in python are for multi-line strings):</p>
<div class="codehilite"><pre><span></span><span class="o">%</span><span class="n">pyspark</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SELECT teamID, max(H) as `max hits` </span>
<span class="sd">    FROM batting </span>
<span class="sd">    GROUP BY teamID </span>
<span class="sd">    ORDER BY(`max hits`) </span>
<span class="sd">    DESC LIMIT 10</span>
<span class="sd">    &quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">z</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>

<div class="admonition warning">
<p>Column aliases with spaces or special characters must be enclosed in <em>backticks</em> and not <em>straight quotes</em> !</p>
</div>
<p>But this is still python. Thanks to Zeppelin, it is possible to run Spark SQL queries and display results directly using a <em>Spark SQL</em> cell. So our query now looks like:</p>
<div class="codehilite"><pre><span></span><span class="o">%</span><span class="k">sql</span>  <span class="c1">-- tell Zeppelin to use the Spark SQL interpreter</span>
<span class="k">SELECT</span> <span class="n">teamID</span><span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="k">as</span> <span class="o">`</span><span class="k">max</span> <span class="n">hits</span><span class="o">`</span> 
<span class="k">FROM</span> <span class="n">batting</span> 
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">teamID</span> 
<span class="k">ORDER</span> <span class="k">BY</span><span class="p">(</span><span class="o">`</span><span class="k">max</span> <span class="n">hits</span><span class="o">`</span><span class="p">)</span> 
<span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">10</span>
</pre></div>

<h3 id="interactive-queries_1">Interactive queries</h3>
<p>Forms fields can also be used in an SQL cell, but the syntax is a bit different:</p>
<ul>
<li>simple form: <code class="codehilite"><span class="cp">${</span><span class="n">input_name</span><span class="o">=</span><span class="n">default_value</span><span class="cp">}</span></code></li>
<li>dropdown: <code class="codehilite"><span class="cp">${</span><span class="n">input_name</span><span class="o">=</span><span class="n">default_value</span><span class="p">,</span><span class="n">value1</span><span class="o">|</span><span class="n">value2</span><span class="o">|</span><span class="n">valueX</span><span class="cp">}</span></code></li>
</ul>
<p>For example, using an input:</p>
<div class="codehilite"><pre><span></span><span class="o">%</span><span class="k">sql</span>
<span class="k">select</span> <span class="n">teamID</span><span class="p">,</span> <span class="k">avg</span><span class="p">(</span><span class="n">HBP</span><span class="p">)</span> <span class="k">as</span> <span class="o">`</span><span class="n">average</span> <span class="n">hit</span> <span class="n">per</span> <span class="n">pitch</span><span class="o">`</span>
<span class="k">from</span> <span class="n">batting</span>
<span class="k">where</span> <span class="n">yearID</span> <span class="o">=</span> <span class="err">${</span><span class="k">year</span><span class="o">=</span><span class="mi">1984</span><span class="err">}</span> <span class="c1">-- let the user choose the year</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">teamID</span>
</pre></div>

<p>using a dropdown:</p>
<p><div class="codehilite"><pre><span></span><span class="o">%</span><span class="k">sql</span>
<span class="k">select</span> <span class="k">distinct</span><span class="p">(</span><span class="n">yearID</span><span class="p">)</span> <span class="k">as</span> <span class="o">`</span><span class="n">years</span> <span class="n">played</span><span class="o">`</span>
<span class="k">from</span> <span class="n">batting</span>
<span class="k">where</span> <span class="n">teamID</span> <span class="o">=</span> <span class="ss">&quot;${team=OAK,OAK|SFN|SDN|PHI}&quot;</span> <span class="c1">-- let the user choose one 4 teams</span>
<span class="k">order</span> <span class="k">by</span> <span class="o">`</span><span class="n">years</span> <span class="n">played</span><span class="o">`</span>
</pre></div>
.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../hive/" title="Hive" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Hive
              </span>
            </div>
          </a>
        
        
          <a href="../spark/" title="Spark" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Spark
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017 DAPLAB & UNIFR
          </div>
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application-f3ab9e5ff8.js"></script>
      
      
      <script>app.initialize({url:{base:".."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
    
      
    
  </body>
</html>